$(function(){function g(){h.removeAllSlides();d.removeAllSlides();d.appendSlide('<div class="swiper-slide" style="background-image: url('+step4Action.getPicture()+');"></div>');h.appendSlide('<div class="swiper-slide" style="background-image: url('+step4Action.getPicture()+');"></div>');$.each(step4Action.getSubPicture(),function(b,c){d.appendSlide("<div data-img="+b+' class="swiper-slide" style="background-image: url('+c+');"></div>');h.appendSlide("<div data-img="+b+' class="swiper-slide" style="background-image: url('+
    c+');"><i class="icon-delete"></i></div>')})}function k(b,c){if(b.files&&0<=b.files.length){for(var d=!0,a=0;a<b.files.length;a++)if(0>$.inArray(b.files[a].name,formData.getValidate()))if(formData.sizeCheck(b.files[a].name,b.files[a].size)){if(formData.extCheck(b.files[a].name)){var e=new FileReader;e.fileName=b.files[a].name;formData.setValidate(b.files[a].name);e.onload=function(b){if(!c){var f=$("<img class='previewImg'>").attr("src",b.target.result);b=$('<div class="previewThumbnail"><a class="icon-x-square" href="javascript:void(0);" data-img="'+
    b.target.fileName+'" onclick="formData.empty(this);"></a></div>').append(f);$("#previewBox").prepend(b)}};e.readAsDataURL(b.files[a])}}else d=!1;c||formData.setFile();d||showAlertMsg("#formErrorMsg",!0)}}var a;$(window).scroll(function(){window.clearTimeout(a);a=window.setTimeout(function(){500<=$(window).scrollTop()?($("header.fixed").addClass("is_scroll"),$("#goTop").stop().fadeIn()):($("header.fixed").removeClass("is_scroll"),$("#goTop").fadeOut())},100)});$("#goTop").click(function(){$("html,body").stop().animate({scrollTop:0},
    800)});$(".scrollTrigger").click(function(){var b=$(this).attr("data-target");b=$("#"+b).offset().top;$("html,body").stop().animate({scrollTop:b-150},1E3)});0<$("#settingsForm").length&&$("#settingsForm").validationEngine("attach",{promptPosition:"inline",addPromptClass:"errorMsg",scroll:!1,maxErrorsPerField:1,onValidationComplete:function(b,c){if(c)return!0;$.fancybox.open({src:"#formErrorMsg",afterClose:function(){$("#formErrorMsg").empty()}})}});$(".itemThumbnail").click(function(){$(".itemThumbnail").removeClass("current");
    $(this).addClass("current");var b=$(this).find("img").attr("data-id");step4Action.check(b)&&(step4Action.checkImage(b),g())});$("#fileupload").change(function(){$(".sectionPreview").fadeIn();k(this,!1)});$(".tabTrigger").click(function(){$(".tabs.active").toggleClass("active");$(this).addClass("active");var b=$(this).attr("data-tab");$(".tabContent.active").toggleClass("active");$("#"+b).addClass("active")});if(0<$(".swiper-container").length){var h=new Swiper(".gallery-thumbs",{spaceBetween:10,slidesPerView:"auto",
    freeMode:!0,watchSlidesVisibility:!0,watchSlidesProgress:!0}),d=new Swiper(".gallery-top",{thumbs:{swiper:h}});$("body").on("click",".swiper-slide .icon-delete",function(){var b=$(".gallery-thumbs .swiper-slide").index($(this).closest(".swiper-slide")),c=$(this).parent().attr("data-img");formData["delete"](c);formData.getStatus()&&(h.removeSlide(b),d.removeSlide(b))});$("#swiperupload").change(function(){if(""==$("#swiperupload").val())return!1;showLoading();k(this,!0);$.ajax({type:"post",url:"get_data.php",
    data:{action:"check"},dataType:"json",success:function(b){b&&(step4Action.upload(),formData.getStatus()&&(g(),clearLoading()))},error:function(){clearLoading();alert("Upload Error")}})})}0<$("#editForm").length&&$("#editForm").validationEngine("attach",{promptPosition:"inline",addPromptClass:"errorMsg",scroll:!1,maxErrorsPerField:1,onValidationComplete:function(b,c){if(c){var a=!0;step4Action.checkStock()||(a=!1);step4Action.checkPrice()||(a=!1);step4Action.checkColor()||(a=!1);if(a)return!0}showAlertMsg("#formErrorMsg",
        !0)}});$("input[type='radio']").on("click",function(){var b=$(this).attr("name")+"_checked",a=$("#"+b).val();"undefined"!=typeof a&&(a==$(this).val()?($("#"+b).val(""),$(this).prop("checked",!1)):$("#"+b).val($(this).val()))})});
var formData=function(){var g="#fileupload",k=0,a,h={},d=!1,b="",c=[],m=[],n=function(){$("#alertMsgBox").html(b);showAlertMsg("#formErrorMsg",!0)},e=function(){a=new FormData;if(0==h.length||0==c.length)return!1;$.each(h,function(b,d){0<=$.inArray(b,c)&&a.append("file["+b+"]",d)});return!0};return{validate:function(f){d=!1;b="";if(!e())return clearLoading(),!1;a.append("action","validate");""!=f&&a.append("step",f);0<k&&a.append("product_id",k);$.ajax({url:"upload.php",cache:!1,contentType:!1,processData:!1,
        data:a,type:"post",async:!1,dataType:"json",success:function(a){$.each(a,function(f,a){0==a.status?(m.push(a.name),b+=a.name+":"+a.msg+"<br>"):0>$.inArray(a.name,c)&&c.push(a.name)});""==b&&(d=!0);d?formData.upload(f):(clearLoading(),n());return!1}})},upload:function(f){if(!e())return clearLoading(),!1;a.append("action","upload");""!=f&&a.append("step",f);0<k&&a.append("product_id",k);$.ajax({url:"upload.php",cache:!1,contentType:!1,processData:!1,data:a,type:"post",async:!1,dataType:"json",success:function(a){$.each(a,
            function(a,f){0==f.status&&(d=!1,b+=f.name+":"+f.msg+"<br>")});d||(clearLoading(),n())}})},"delete":function(a){d=!1;b="";$.ajax({url:"upload.php",data:{action:"delete",step:"step4",image:a},type:"post",dataType:"json",async:!1,success:function(a){0==a.status?(d=!1,b=a.msg,n()):d=!0}});return!1},getStatus:function(){return d},getEmptyData:function(){return m},setValidate:function(b){c.push(b)},getValidate:function(){return c},empty:function(b){var a=$(b).attr("data-img");0<c.length&&(c=c.filter(function(b){return b!=
        a}));"undefined"!=typeof h[a]&&delete h[a];$(b).parent(".previewThumbnail").remove()},setFile:function(){var b=$(g).prop("files");if(0==b.length||0==c.length)return!1;for(var a=0;a<b.length;a++)0<=$.inArray(b[a].name,c)&&(h[b[a].name]=b[a])},emptyFileData:function(){h={}},emptyValidate:function(){c=[]},setFormData:function(b,a){g=b;k=a},extCheck:function(b){var a=b.lastIndexOf(".");b=b.substring(a,b.length).toUpperCase();return".PNG"==b||".GIF"==b||".JPG"==b||".JPEG"==b?!0:!1},sizeCheck:function(b,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             a){return 512E3<parseInt(a)?($("#formErrorMsg").append("* "+b+"\u8d85\u904e500Kb<br>"),!1):!0}}}(),step2Action=function(){return{submit:function(){showLoading();$.ajax({type:"POST",url:"get_data.php",data:{action:"check"},dataType:"json",success:function(g){g&&(formData.validate("step2"),formData.getStatus()?$("#uploadMajor").submit():$.each($(".icon-x-square"),function(g,a){0<=$.inArray($(a).attr("data-img"),formData.getEmptyData())&&formData.empty(a)}))}})}}}(),step3Action=function(){var g=[],k=
    function(){$.ajax({url:"get_data.php",data:{action:"startProcessData"},type:"post",async:!1,dataType:"json",success:function(a){a.status&&(g=a.data)}})},a=function(){k();if(0==g.length)return clearLoading(),!1;$.ajax({type:"post",url:"/longtask",data:JSON.stringify([g]),contentType:"application/json",dataType:"json",async:!1,success:function(a,b,c){a=c.getResponseHeader("Location");h(a)},error:function(){alert("startProcess error");clearLoading()}})},h=function(a){$.getJSON(a+"?_="+(new Date).getTime(),
    function(b){var c=parseInt(""+100*b.current/b.total);$(".percent").text(c+"%");"PENDING"!=b.state&&"PROGRESS"!=b.state?$("#uploadMajor").submit():setTimeout(function(){h(a)},2E3)})};return{submit:function(){showLoading();$.ajax({type:"POST",url:"get_data.php",data:{action:"check"},dataType:"json",success:function(d){d&&(0!=formData.getValidate().length?(formData.validate("step3"),formData.getStatus()?a():$.each($(".icon-x-square"),function(b,a){0<=$.inArray($(a).attr("data-img"),formData.getEmptyData())&&
        formData.empty(a)})):a())}})}}}(),step4Action=function(){var g=!0,k,a={},h={},d=[],b=[],c=function(){k="";a={};h={};d=[];b=[]},m=function(b){$.ajax({url:"get_data.php",data:{action:"getProductData",id:b},type:"post",async:!1,dataType:"json",success:function(b){b.status?(k=b.data.picture,$.each(b.data.sub_picture,function(b,l){a[b]=l}),$.each(b.data.product,function(b,a){h[b]=a})):(g=!1,clearLoading())},error:function(){alert("getProductData error");clearLoading()}})},n=function(){$.each(h,function(b,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               a){""!=a&&null!=a&&("id"==b&&$("#id").val(a),"pchome_category"==b&&$("#pchome_category").val(a),"ruten_category"==b&&$("#ruten_category").val(a),"yahoo_category"==b&&$("#yahoo_category").val(a),"name"==b&&$("#name").val(a),"price"==b&&$("#price").val(a),"sell_price"==b&&$("#sell_price").val(a),"stock"==b&&$("#stock").val(a),"is_new"==b&&e("is_new",a),"site"==b&&$("#site").val(a),"posting_days"==b&&$("#posting_days").val(a),"sub_category"==b&&e("sub_category",a),"sub_category_custom_field"==b&&$("#sub_category_custom_field").val(a),
"category"==b&&e("category",a),"fabric"==b&&e("fabric",a),"color"==b&&e("color",a),"color_custom_field"==b&&$("#color_custom_field").val(a),"size"==b&&e("size",a),"size_custom_field"==b&&$("#size_custom_field").val(a),"collar"==b&&e("collar",a),"collar_custom_field"==b&&$("#collar_custom_field").val(a),"neckline"==b&&e("neckline",a),"neckline_custom_field"==b&&$("#neckline_custom_field").val(a),"sleeve"==b&&e("sleeve",a),"sleeve_custom_field"==b&&$("#sleeve_custom_field").val(a),"feature_1"==b&&e("feature1",
    a),"feature_1_custom_field"==b&&$("#feature1_custom_field").val(a),"feature_2"==b&&e("feature2",a),"feature_2_custom_field"==b&&$("#feature2_custom_field").val(a),"feature_3"==b&&e("feature3",a),"feature_3_custom_field"==b&&$("#feature3_custom_field").val(a),"feature_4"==b&&e("feature4",a),"feature_4_custom_field"==b&&$("#feature4_custom_field").val(a),"feature_5"==b&&e("feature5",a),"feature_5_custom_field"==b&&$("#feature5_custom_field").val(a),"keyword"==b&&e("keyword",a),"keyword_custom_field"==
b&&$("#keyword_custom_field").val(a),"product_description"==b&&$("#product_description").val(a),"is_edit"==b&&(1==a?$("#preview").css("visibility","visible"):$("#preview").css("visibility","hidden")))})},e=function(b,a){var l=a.split(",");$.each($("."+b),function(b,a){-1!=l.indexOf($(a).val())&&$(a).prop("checked",!0)})},f=function(b){$.each($("."+b),function(b,a){$(a).is(":checked")&&"custom"!=$(a).val()&&d.push($(a).val())})},r=function(b){$.ajax({type:"post",url:"/renewsentence",data:JSON.stringify([{strings:b}]),
    contentType:"application/json",dataType:"json",cache:!1,success:function(b,a,l){b=l.getResponseHeader("Location");p(b)},error:function(){alert("RenewSentence error");clearLoading()}})},p=function(a){$.getJSON(a+"?_="+(new Date).getTime(),function(l){var c=parseInt(""+100*l.current/l.total);$(".percent").text(c+"%");"PENDING"!=l.state&&"PROGRESS"!=l.state?($.each(l.result,function(a,l){b.push(l)}),q(),clearLoading()):setTimeout(function(){p(a)},2E3)})},q=function(){var a="",c=$("#id").val();$.each(b,
    function(b,l){a=""==a?a+l:a+("\n"+l)});$.ajax({type:"POST",url:"get_data.php",data:{action:"saveProductDescription",id:c,string:a},async:!1,dataType:"json",success:function(b){b&&(b.status?$("#product_description").val(a):(g=!1,clearLoading()))}})};return{getPicture:function(){return k},getSubPicture:function(){return a},check:function(b){return"undefined"==typeof $("#id")||$("#id").val()==b?!1:!0},checkImage:function(b){showLoading();c();"undefined"!=typeof $("#id")&&$("#id").val("");"undefined"!=
    typeof $("#pchome_category")&&$("#pchome_category").val("");"undefined"!=typeof $("#ruten_category")&&$("#ruten_category").val("");"undefined"!=typeof $("#yahoo_category")&&$("#yahoo_category").val("");"undefined"!=typeof $("#name")&&$("#name").val("");"undefined"!=typeof $("#price")&&$("#price").val("");"undefined"!=typeof $("#sell_price")&&$("#sell_price").val("");"undefined"!=typeof $("#stock")&&$("#stock").val("");"undefined"!=typeof $("#is_new")&&$(".is_new").prop("checked",!1);"undefined"!=
    typeof $("#site")&&$("#site").val("");"undefined"!=typeof $("#posting_days")&&$("#posting_days").val("");"undefined"!=typeof $(".sub_category")&&$(".sub_category").prop("checked",!1);"undefined"!=typeof $("#sub_category_custom_field")&&$("#sub_category_custom_field").val("");"undefined"!=typeof $(".category")&&$(".category").prop("checked",!1);"undefined"!=typeof $(".fabric")&&$(".fabric").prop("checked",!1);"undefined"!=typeof $(".color")&&$(".color").prop("checked",!1);"undefined"!=typeof $("#color_custom_field")&&
    $("#color_custom_field").val("");"undefined"!=typeof $(".size")&&$(".size").prop("checked",!1);"undefined"!=typeof $("#size_custom_field")&&$("#size_custom_field").val("");"undefined"!=typeof $(".collar")&&$(".collar").prop("checked",!1);"undefined"!=typeof $("#collar_custom_field")&&$("#collar_custom_field").val("");"undefined"!=typeof $(".neckline")&&$(".neckline").prop("checked",!1);"undefined"!=typeof $("#neckline_custom_field")&&$("#neckline_custom_field").val("");"undefined"!=typeof $(".sleeve")&&
    $(".sleeve").prop("checked",!1);"undefined"!=typeof $("#sleeve_custom_field")&&$("#sleeve_custom_field").val("");"undefined"!=typeof $(".feature1")&&$(".feature1").prop("checked",!1);"undefined"!=typeof $("#feature1_custom_field")&&$("#feature1_custom_field").val("");"undefined"!=typeof $(".feature2")&&$(".feature2").prop("checked",!1);"undefined"!=typeof $("#feature2_custom_field")&&$("#feature2_custom_field").val("");"undefined"!=typeof $(".feature3")&&$(".feature3").prop("checked",!1);"undefined"!=
    typeof $("#feature3_custom_field")&&$("#feature3_custom_field").val("");"undefined"!=typeof $(".feature4")&&$(".feature4").prop("checked",!1);"undefined"!=typeof $("#feature4_custom_field")&&$("#feature4_custom_field").val("");"undefined"!=typeof $(".feature5")&&$(".feature5").prop("checked",!1);"undefined"!=typeof $("#feature5_custom_field")&&$("#feature5_custom_field").val("");"undefined"!=typeof $(".keyword")&&$(".keyword").prop("checked",!1);"undefined"!=typeof $("#keyword_custom_field")&&$("#keyword_custom_field").val("");
        "undefined"!=typeof $("#product_description")&&$("#product_description").val("");m(b);g&&n();clearLoading()},upload:function(){c();var b=$("#id").val();formData.emptyFileData();formData.setFormData("#swiperupload",b);formData.setFile();formData.validate("step4");formData.emptyValidate();m(b)},buildProductDescription:function(){showLoading();c();var a=$("#id").val();"undefined"!=typeof $(".collar")&&f("collar");"undefined"!=typeof $(".neckline")&&f("neckline");"undefined"!=typeof $(".sleeve")&&f("sleeve");
        "undefined"!=typeof $(".feature1")&&f("feature1");"undefined"!=typeof $(".feature2")&&f("feature2");"undefined"!=typeof $(".feature3")&&f("feature3");"undefined"!=typeof $(".feature4")&&f("feature4");"undefined"!=typeof $(".feature5")&&f("feature5");$.ajax({type:"POST",url:"get_data.php",data:{action:"buildProductDescription",id:a,data:d},dataType:"json",success:function(a){a&&(a.status?""==a.data.strings?($.each(a.data.data,function(a,c){b.push(c)}),q(),clearLoading()):($.each(a.data.data,function(a,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                c){b.push(c)}),r(a.data.strings)):(g=!1,clearLoading()))}})},previewProductPage:function(a){var b=$("#id").val();a=a.split(",");$.each(a,function(a,c){window.open("preview.php?type="+c+"&product_id="+b)})},download:function(){$("#id").val();window.open("download.php")},checkStock:function(){var a=$("#sizeCustom").prop("checked"),b=$("#sizeCustom").siblings(".customField").val().split(",").length,c=$("input[name='size[]']:checked").length,d=$('input[name="stock"]').val().split(","),e=d.length,f=!0;
        $.each(d,function(a,b){var c=b.trim();c=/^\d+$/.test(c)?!0:!1;c||(f=!1)});f||$("#formErrorMsg").append("* \u5eab\u5b58\u6578\u91cf\u9808\u70ba\u6b63\u6574\u6578\u62160!<br>");a=a?c-1+b:c;a!=e&&(a>e?$("#formErrorMsg").append("* \u518d\u6b21\u6aa2\u67e5\uff01\u60a8\u8a2d\u5b9a"+a+"\u500b\u5c3a\u5bf8\uff0c\u53ea\u6709"+e+"\u500b\u5c3a\u5bf8\u6709\u586b\u5beb\u5eab\u5b58\u6578\u91cf<br>"):$("#formErrorMsg").append("* \u518d\u6b21\u6aa2\u67e5\uff01\u60a8\u8a2d\u5b9a"+a+"\u500b\u5c3a\u5bf8\uff0c\u537b\u6709"+
            e+"\u500b\u5eab\u5b58\u6578\u91cf<br>"));return a==e&&f?!0:!1},checkPrice:function(){var a=$("#price").val(),b=$("#sell_price").val();return parseInt(a)<=parseInt(b)?($("#formErrorMsg").append("* \u5546\u54c1\u552e\u50f9/\u4fc3\u92b7 \u9808\u5c0f\u65bc \u539f\u50f9!<br>"),!1):0==parseInt(a)||0==parseInt(b)?($("#formErrorMsg").append("* \u5546\u54c1\u552e\u50f9/\u4fc3\u92b7\u548c\u539f\u50f9\u9808\u5927\u65bc0!<br>"),!1):!0},checkColor:function(){var a=$("input[name='color']:checked").val(),b=$("#color_custom_field").val();
        return"undefined"==typeof a||""==a||"custom"==a&&""==b?($("#formErrorMsg").append("* \u8acb\u586b\u5beb\u984f\u8272<br>"),!1):!0}}}();function clearLoading(){$(".loading").fadeOut()}function showLoading(){$(".loading").show()}function showAlertMsg(g,k){k?$.fancybox.open({src:g,afterClose:function(){$(g).empty()}}):$.fancybox.open({src:g})};